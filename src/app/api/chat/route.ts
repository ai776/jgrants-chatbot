import { NextRequest, NextResponse } from 'next/server';

interface JGrantsSubsidy {
  id: string;
  title: string;
  subsidy_max_limit?: number;
  acceptance_end_datetime?: string;
  deadline_status?: string;
  target_area_search?: string;
  target_industry?: string;
  detail?: string;
}

interface JGrantsSearchResponse {
  results: JGrantsSubsidy[];
  total_count: number;
  page: number;
  limit: number;
}

interface JGrantsDetailResponse {
  id: string;
  title: string;
  detail: string;
  subsidy_max_limit?: number;
  subsidy_rate?: string;
  acceptance_start_datetime?: string;
  acceptance_end_datetime?: string;
  deadline_status?: string;
  target_area_search?: string;
  target_industry?: string;
  target_number_of_employees?: string;
  inquiry_url?: string;
  update_datetime?: string;
  files?: {
    application_guidelines?: string[];
    outline_of_grant?: string[];
    application_form?: string[];
  };
  save_directory?: string;
}

const MCP_SERVER_URL = process.env.MCP_SERVER_URL || 'http://localhost:8000';
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;

async function callMCPTool(toolName: string, args: Record<string, any>): Promise<any> {
  try {
    const response = await fetch(`${MCP_SERVER_URL}/mcp`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        jsonrpc: '2.0',
        method: 'tools/call',
        params: {
          name: toolName,
          arguments: args,
        },
        id: Date.now(),
      }),
    });

    if (!response.ok) {
      throw new Error(`MCP server error: ${response.statusText}`);
    }

    const data = await response.json();
    return data.result?.content?.[0]?.text ? JSON.parse(data.result.content[0].text) : data.result;
  } catch (error) {
    console.error('MCP call error:', error);
    throw error;
  }
}

async function callOpenAI(messages: Array<{ role: string; content: string }>): Promise<string> {
  if (!OPENAI_API_KEY) {
    throw new Error('OPENAI_API_KEY is not set');
  }

  try {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${OPENAI_API_KEY}`,
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: messages,
        temperature: 0.7,
        max_tokens: 2000,
      }),
    });

    if (!response.ok) {
      const error = await response.text();
      throw new Error(`OpenAI API error: ${error}`);
    }

    const data = await response.json();
    return data.choices[0].message.content;
  } catch (error) {
    console.error('OpenAI call error:', error);
    throw error;
  }
}

function analyzeIntent(message: string): { intent: string; params: Record<string, any> } {
  const lowerMessage = message.toLowerCase();

  // „Ç≠„Éº„ÉØ„Éº„ÉâÊäΩÂá∫
  const keywords = {
    location: ['Êù±‰∫¨', 'Â§ßÈò™', 'Á•ûÂ•àÂ∑ù', 'ÊÑõÁü•', 'Á¶èÂ≤°', 'ÂåóÊµ∑ÈÅì', 'ÂÖ®ÂõΩ'],
    industry: ['Ë£ΩÈÄ†Ê•≠', 'IT', 'DX', '„Éá„Ç∏„Çø„É´', '„Çπ„Çø„Éº„Éà„Ç¢„ÉÉ„Éó', 'Â∞èÂ£≤', '„Çµ„Éº„Éì„Çπ'],
    amount: /(\d+)‰∏áÂÜÜ/,
    deadline: ['‰ªäÊúà', 'Êù•Êúà', '3„É∂Êúà', 'Á∑†Âàá', 'ÊúüÈôê'],
  };

  // ÊÑèÂõ≥„ÅÆÂà§ÂÆö
  if (lowerMessage.includes('ÊúÄÊñ∞') || lowerMessage.includes('Êñ∞„Åó„ÅÑ')) {
    return {
      intent: 'search_latest',
      params: {
        keyword: '‰∫ãÊ•≠',
        sort: 'created',
        order: 'desc',
        acceptance: 1,
        limit: 10,
      },
    };
  }

  if (lowerMessage.includes('Ë©≥Á¥∞') || lowerMessage.includes('Êïô„Åà„Å¶')) {
    // ID„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
    const idMatch = message.match(/[a-zA-Z0-9]{18}/);
    if (idMatch) {
      return {
        intent: 'get_detail',
        params: {
          subsidy_id: idMatch[0],
        },
      };
    }
  }

  if (lowerMessage.includes('Áµ±Ë®à') || lowerMessage.includes('ÂÖ®‰Ωì')) {
    return {
      intent: 'get_statistics',
      params: {
        keyword: '‰∫ãÊ•≠',
        acceptance: 1,
        output_format: 'summary',
      },
    };
  }

  // ÈÄöÂ∏∏„ÅÆÊ§úÁ¥¢
  let keyword = '‰∫ãÊ•≠';

  // Ê•≠Á®Æ„Ç≠„Éº„ÉØ„Éº„Éâ„ÅÆÊäΩÂá∫
  for (const ind of keywords.industry) {
    if (lowerMessage.includes(ind.toLowerCase())) {
      keyword = ind;
      break;
    }
  }

  // Âú∞Âüü„ÅÆÊäΩÂá∫
  let hasLocation = false;
  for (const loc of keywords.location) {
    if (lowerMessage.includes(loc)) {
      hasLocation = true;
      break;
    }
  }

  return {
    intent: 'search',
    params: {
      keyword,
      sort: 'acceptance_end',
      order: 'asc',
      acceptance: 1,
      limit: 15,
    },
  };
}

function formatSearchResults(data: JGrantsSearchResponse): string {
  if (!data.results || data.results.length === 0) {
    return 'Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇË©≤ÂΩì„Åô„ÇãË£úÂä©Èáë„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇÂà•„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ„Åß„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
  }

  let response = `${data.total_count}‰ª∂„ÅÆË£úÂä©Èáë„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü„ÄÇ‰∏ª„Å™Ë£úÂä©Èáë„Çí„ÅîÁ¥π‰ªã„Åó„Åæ„ÅôÔºö\n\n`;

  data.results.slice(0, 5).forEach((subsidy, index) => {
    response += `„Äê${index + 1}„Äë${subsidy.title}\n`;

    if (subsidy.subsidy_max_limit) {
      response += `üí∞ Ë£úÂä©‰∏äÈôêÈ°ç: ${(subsidy.subsidy_max_limit / 10000).toLocaleString()}‰∏áÂÜÜ\n`;
    }

    if (subsidy.deadline_status) {
      const statusEmoji = subsidy.deadline_status === 'ÊúüÈôêÈñìËøë' ? '‚ö†Ô∏è' : 'üìÖ';
      response += `${statusEmoji} Âèó‰ªòÁä∂Ê≥Å: ${subsidy.deadline_status}\n`;
    }

    if (subsidy.acceptance_end_datetime) {
      const endDate = new Date(subsidy.acceptance_end_datetime);
      response += `üìÜ Á∑†Âàá: ${endDate.toLocaleDateString('ja-JP')}\n`;
    }

    if (subsidy.target_area_search) {
      response += `üåç ÂØæË±°Âú∞Âüü: ${subsidy.target_area_search}\n`;
    }

    if (subsidy.target_industry) {
      response += `üè¢ ÂØæË±°Ê•≠Á®Æ: ${subsidy.target_industry}\n`;
    }

    if (subsidy.detail) {
      response += `üìù Ê¶ÇË¶Å: ${subsidy.detail}\n`;
    }

    response += `üîó ID: ${subsidy.id}\n\n`;
  });

  if (data.total_count > 5) {
    response += `‰ªñ„Å´„ÇÇ${data.total_count - 5}‰ª∂„ÅÆË£úÂä©Èáë„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\n`;
    response += `Ë©≥Á¥∞„ÇíÁü•„Çä„Åü„ÅÑÂ†¥Âêà„ÅØ„ÄÅË£úÂä©Èáë„ÅÆID„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
  }

  return response;
}

function formatDetailResult(data: JGrantsDetailResponse): string {
  let response = `„Äê${data.title}„Äë„ÅÆË©≥Á¥∞ÊÉÖÂ†±\n\n`;

  response += `üìù Ê¶ÇË¶Å:\n${data.detail}\n\n`;

  if (data.subsidy_max_limit) {
    response += `üí∞ Ë£úÂä©‰∏äÈôêÈ°ç: ${(data.subsidy_max_limit / 10000).toLocaleString()}‰∏áÂÜÜ\n`;
  }

  if (data.subsidy_rate) {
    response += `üìä Ë£úÂä©Áéá: ${data.subsidy_rate}\n`;
  }

  if (data.acceptance_start_datetime && data.acceptance_end_datetime) {
    const startDate = new Date(data.acceptance_start_datetime);
    const endDate = new Date(data.acceptance_end_datetime);
    response += `üìÖ Âèó‰ªòÊúüÈñì: ${startDate.toLocaleDateString('ja-JP')} „Äú ${endDate.toLocaleDateString('ja-JP')}\n`;
  }

  if (data.deadline_status) {
    response += `‚è∞ Âèó‰ªòÁä∂Ê≥Å: ${data.deadline_status}\n`;
  }

  if (data.target_area_search) {
    response += `üåç ÂØæË±°Âú∞Âüü: ${data.target_area_search}\n`;
  }

  if (data.target_industry) {
    response += `üè¢ ÂØæË±°Ê•≠Á®Æ: ${data.target_industry}\n`;
  }

  if (data.target_number_of_employees) {
    response += `üë• ÂØæË±°‰ºÅÊ•≠Ë¶èÊ®°: ${data.target_number_of_employees}\n`;
  }

  if (data.inquiry_url) {
    response += `\nüîó Ë©≥Á¥∞URL: ${data.inquiry_url}\n`;
  }

  if (data.files) {
    response += `\nüìé Ê∑ª‰ªò„Éï„Ç°„Ç§„É´:\n`;
    if (data.files.application_guidelines && data.files.application_guidelines.length > 0) {
      response += `  - ÂÖ¨ÂãüË¶ÅÈ†ò: ${data.files.application_guidelines.length}‰ª∂\n`;
    }
    if (data.files.outline_of_grant && data.files.outline_of_grant.length > 0) {
      response += `  - Ê¶ÇË¶ÅË≥áÊñô: ${data.files.outline_of_grant.length}‰ª∂\n`;
    }
    if (data.files.application_form && data.files.application_form.length > 0) {
      response += `  - Áî≥Ë´ãÊßòÂºè: ${data.files.application_form.length}‰ª∂\n`;
    }
  }

  response += `\n‚Äª ÊúÄÊñ∞ÊÉÖÂ†±„ÅØÂÖ¨Âºè„Çµ„Ç§„Éà„Åß„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ`;

  return response;
}

function formatStatisticsResult(data: any): string {
  let response = `üìä Ë£úÂä©ÈáëÁµ±Ë®àÊÉÖÂ†±\n\n`;

  response += `üìà Á∑è‰ª∂Êï∞: ${data.total_count}‰ª∂Ôºà„Çµ„É≥„Éó„É´: ${data.sampled_count}‰ª∂Ôºâ\n\n`;

  if (data.deadline_distribution) {
    response += `üìÖ Á∑†ÂàáÊúàÂà•ÂàÜÂ∏É:\n`;
    Object.entries(data.deadline_distribution)
      .slice(0, 5)
      .forEach(([month, count]) => {
        response += `  ${month}: ${count}‰ª∂\n`;
      });
    response += `\n`;
  }

  if (data.amount_distribution) {
    response += `üí∞ Ë£úÂä©ÈáëÈ°çÂàÜÂ∏É:\n`;
    Object.entries(data.amount_distribution).forEach(([range, count]) => {
      response += `  ${range}: ${count}‰ª∂\n`;
    });
    response += `\n`;
  }

  if (data.area_distribution) {
    response += `üåç Âú∞ÂüüÂà•ÂàÜÂ∏ÉÔºà‰∏ä‰Ωç5‰ª∂Ôºâ:\n`;
    Object.entries(data.area_distribution)
      .sort(([, a]: any, [, b]: any) => b - a)
      .slice(0, 5)
      .forEach(([area, count]) => {
        response += `  ${area}: ${count}‰ª∂\n`;
      });
  }

  return response;
}

export async function POST(request: NextRequest) {
  try {
    const { message } = await request.json();

    if (!message || typeof message !== 'string') {
      return NextResponse.json(
        { error: '„É°„ÉÉ„Çª„Éº„Ç∏„ÅåÂøÖË¶Å„Åß„Åô' },
        { status: 400 }
      );
    }

    // If OpenAI API is not available, use fallback mode
    if (!OPENAI_API_KEY) {
      console.warn('OPENAI_API_KEY not set, using fallback mode');
      // Fallback to simple keyword-based search
      const mcpResponse = await callMCPTool('search_subsidies', {
        keyword: '‰∫ãÊ•≠',
        sort: 'created',
        order: 'desc',
        acceptance: 1,
        limit: 10,
      });
      const formattedResponse = formatSearchResults(mcpResponse);
      return NextResponse.json({
        response: formattedResponse,
        raw: mcpResponse,
      });
    }

    // Use OpenAI to understand user intent and extract keywords
    const systemPrompt = `„ÅÇ„Å™„Åü„ÅØJ„Ç∞„É©„É≥„ÉÑË£úÂä©ÈáëÊ§úÁ¥¢„ÅÆ„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇ„É¶„Éº„Ç∂„Éº„ÅÆË≥™Âïè„ÇíÂàÜÊûê„Åó„Å¶„ÄÅ‰ª•‰∏ã„ÅÆ„ÅÑ„Åö„Çå„Åã„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÊ±∫ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

1. search: „Ç≠„Éº„ÉØ„Éº„ÉâÊ§úÁ¥¢
2. detail: Ë£úÂä©ÈáëID„Åã„ÇâË©≥Á¥∞„ÇíÂèñÂæó
3. statistics: Áµ±Ë®àÊÉÖÂ†±„ÇíÂèñÂæó

„É¶„Éº„Ç∂„Éº„ÅÆË≥™Âïè„Åã„Çâ„ÄÅÂÆüË°å„Åô„Çã„Ç¢„ÇØ„Ç∑„Éß„É≥Âêç„Å®„ÄÅÂøÖË¶Å„Å™„Éë„É©„É°„Éº„Çø(keyword, subsidy_id „Å™„Å©)„ÇíJSONÂΩ¢Âºè„ÅßËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

‰æãÔºö
„É¶„Éº„Ç∂„ÉºË≥™Âïè: "ÊúÄÊñ∞„ÅÆË£úÂä©Èáë„ÇíÊïô„Åà„Å¶"
ÂøúÁ≠î: {"action": "search", "keyword": "‰∫ãÊ•≠", "sort": "created"}

„É¶„Éº„Ç∂„ÉºË≥™Âïè: "Êù±‰∫¨ÈÉΩ„ÅÆË£ΩÈÄ†Ê•≠Âêë„ÅëË£úÂä©Èáë„ÅØ„ÅÇ„Çã?"
ÂøúÁ≠î: {"action": "search", "keyword": "Ë£ΩÈÄ†Ê•≠", "area": "Êù±‰∫¨"}`;

    const intentMessages = [
      {
        role: 'system',
        content: systemPrompt,
      },
      {
        role: 'user',
        content: message,
      },
    ];

    // Get intent from OpenAI
    const intentResponse = await callOpenAI(intentMessages);
    let actionData;

    try {
      actionData = JSON.parse(intentResponse);
    } catch {
      // If JSON parsing fails, default to search
      actionData = { action: 'search', keyword: message };
    }

    let mcpResponse;
    let formattedResponse;

    switch (actionData.action) {
      case 'detail': {
        mcpResponse = await callMCPTool('get_subsidy_detail', {
          subsidy_id: actionData.subsidy_id,
        });
        formattedResponse = formatDetailResult(mcpResponse);
        break;
      }

      case 'statistics': {
        mcpResponse = await callMCPTool('get_subsidy_statistics', {
          keyword: actionData.keyword || '‰∫ãÊ•≠',
          acceptance: 1,
          output_format: 'summary',
        });
        formattedResponse = formatStatisticsResult(mcpResponse);
        break;
      }

      case 'search':
      default: {
        mcpResponse = await callMCPTool('search_subsidies', {
          keyword: actionData.keyword || '‰∫ãÊ•≠',
          sort: actionData.sort || 'created',
          order: actionData.order || 'desc',
          acceptance: 1,
          limit: 15,
        });
        formattedResponse = formatSearchResults(mcpResponse);
        break;
      }
    }

    // Generate natural response using OpenAI
    const contextMessages = [
      {
        role: 'system',
        content: `„ÅÇ„Å™„Åü„ÅØJ„Ç∞„É©„É≥„ÉÑË£úÂä©ÈáëÊ§úÁ¥¢„ÅÆ„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇ„É¶„Éº„Ç∂„Éº„ÅÆË≥™Âïè„Å´ÂØæ„Åó„Å¶„ÄÅÂèñÂæó„Åó„ÅüË£úÂä©ÈáëÊÉÖÂ†±„ÇíÂü∫„Å´„ÄÅËá™ÁÑ∂„ÅßÂàÜ„Åã„Çä„ÇÑ„Åô„ÅÑÊó•Êú¨Ë™û„ÅßÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
        
ÊÉÖÂ†±„Å´„ÅØÁµµÊñáÂ≠ó„ÇíÂê´„Çì„Åß„ÅÑ„Çã„ÅÆ„Åß„ÄÅ„Åù„ÅÆ„Åæ„Åæ‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
      },
      {
        role: 'user',
        content: `„É¶„Éº„Ç∂„Éº„ÅÆË≥™Âïè: "${message}"

ÂèñÂæó„Åó„ÅüË£úÂä©ÈáëÊÉÖÂ†±:
${formattedResponse}

„Åì„ÅÆÊÉÖÂ†±„ÇíÂü∫„Å´„ÄÅ„É¶„Éº„Ç∂„Éº„Å´ÂàÜ„Åã„Çä„ÇÑ„Åô„ÅèË™¨Êòé„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
      },
    ];

    const naturalResponse = await callOpenAI(contextMessages);

    return NextResponse.json({
      response: naturalResponse,
      raw: mcpResponse,
    });
  } catch (error) {
    console.error('Chat API error:', error);
    return NextResponse.json(
      {
        error: '„Çµ„Éº„Éê„Éº„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü',
        response: 'Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ\n\nMCP„Çµ„Éº„Éê„Éº„Å®OpenAI API„ÅÆÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
      },
      { status: 500 }
    );
  }
}
